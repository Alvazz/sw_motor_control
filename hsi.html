
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Hall Sensor Interface &mdash; Motor Control Platform Software Guide v2.0.0 documentation</title>
    <link rel="stylesheet" href="_static/xdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://mathjax.connectmv.com/MathJax.js"></script>
    <script type="text/javascript" src="_static/xcomment.js"></script>
    <link rel="top" title="Motor Control Platform Software Guide v2.0.0 documentation" href="index.html" />
    <link rel="next" title="Quadrature Encoder Input" href="qei.html" />
    <link rel="prev" title="Application Level Communications Interfaces" href="comms-high.html" /> 

<script>
function setheight() {
h1 = document.getElementById('d1').style.height;
h2 = document.getElementById('d2').style.height;

if (parseInt(h1) > parseInt(h2)) {
document.getElementById('d2').style.height=h1 + "px";
}
else {
document.getElementById('d1').style.height=h2 + "px";
}

}
</script>
</head>

<body onload="setheight();">

  

    <div class="document" id='d1'>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
<div style="float: right">
<a href="comms-high.html"
                        title="previous chapter"> &lt&lt </a>
<a href="qei.html"
                        title="next chapter"> &gt&gt </a></p>
</div>

            
  <div class="section" id="hall-sensor-interface">
<h1>Hall Sensor Interface<a class="headerlink" href="#hall-sensor-interface" title="Permalink to this headline">¶</a></h1>
<p>The hall sensor interface is used for measuring speed and estimating the position of the motor.</p>
<div class="section" id="hall-sensor-usage">
<h2>Hall Sensor Usage<a class="headerlink" href="#hall-sensor-usage" title="Permalink to this headline">¶</a></h2>
<p>The hall sensor input module provides a number of functions and options in its usage. A listing of the available functions is given below.</p>
<div class="highlight-none"><div class="highlight"><pre>#include &quot;hall_input.h&quot;

void run_hall_speed_timed( chanend c_hall,
      chanend c_speed,
      port in p_hall,
      chanend ?c_logging_0,
      chanend ?c_logging_1 );

void do_hall( unsigned &amp;hall_state,
      unsigned &amp;cur_pin_state,
      port in p_hall );

select do_hall_select( unsigned &amp;hall_state,
      unsigned &amp;cur_pin_state,
      port in p_hall );
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">run_hall_speed_timed(...)</span></tt> provides a server thread which measures the time between hall sensor state transitions on a 4 bit port as provided on the motor control platform. This functions implementation is described in more detail below.</p>
<p><tt class="docutils literal"><span class="pre">do_hall(...)</span></tt> simply writes the next hall state into the <em>hall_state</em> variable and current pin state into the cur_pin_state variable.</p>
<p><tt class="docutils literal"><span class="pre">do_hall_select(...)</span></tt> is the same as <tt class="docutils literal"><span class="pre">do_hall</span></tt> but is a select function. This function is used in the basic BLDC demonstration application.</p>
</div>
<div class="section" id="hall-sensor-client">
<h2>Hall Sensor Client<a class="headerlink" href="#hall-sensor-client" title="Permalink to this headline">¶</a></h2>
<p>When using the hall sensor server thread as described above, the information may be accessed by using the client functions as listed below.</p>
<div class="highlight-none"><div class="highlight"><pre>#include &quot;hall_client.h&quot;

{unsigned,unsigned,unsigned} get_hall_pos_speed_delta(chanend c_hall);
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">get_hall_pos_speed_delta(...)</span></tt> will request and subsequently return the theta, speed and delta values respectively from the hall input server thread. The theta value is an estimated value, speed is in revolutions per minute (RPM) and delta is currently used for debugging purposes.</p>
</div>
<div class="section" id="hall-sensor-server-implementation">
<h2>Hall Sensor Server Implementation<a class="headerlink" href="#hall-sensor-server-implementation" title="Permalink to this headline">¶</a></h2>
<p><em>This code is currently considered experimental</em></p>
<p>The function <tt class="docutils literal"><span class="pre">run_hall_speed_timed(...)</span></tt> provides a thread that handles hall sensor input functions, speed and angle estimations.</p>
<p>After initialising the ports and initialising the current hall sensor state the code enters a startup phase. This is where an ideal
theta value is passed to the client as the motor is not yet actually turning, so no angular estimation can be made. This continues
until the hall sensor thread has received two transitions.</p>
<p>Following the initial startup sequence the hall sensor thread enters the main operational loop. This comprises of a select statement
that handles either a request for information from the clients, a timeout to detect no rotation or a state transition on hall sensor.</p>
<p>When a new transition is received the new hall state is stored and the current theta base value is updated. This base value is defined
as the angular location of the hall sensor within the motor. The system then defines what the next hall sensor state it should wait
for will be.</p>
<p>Once the base angle and next state values have been updated the timing calculations are completed to define the speed and angle
calculation. Speed calculation is defined by looking for a full mechanical rotation of the motor where it returns to a defined state.</p>
<p>When the thread receives a request for speed and angle information these are calculated and then delivered over the change. The angle
estimation is done by considering the time the motor has taken to travel over a hall sensor sector. It assumes that the hall sensor
data is requested at a regular time over the sector (which as it is blocked by the PWM it will be in the example FOC implementation).</p>
<p>Once the values are calculated they are provided to the client over the channel.</p>
</div>
</div>



          </div>
        </div>
      </div>
      <div class="sphinxsidebar" id='d2'>
        <div class="sphinxsidebarwrapper">
<h3><a href="index.html">Motor Control Platform Software Guide (2.0.0)</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="apps.html">Motor Control Platform Example Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="blocks.html">Processing Blocks</a></li>
<li class="toctree-l1"><a class="reference internal" href="display.html">Display and Shared IO Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="pwm.html">Pulse Width Modulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="adc.html">Analogue to Digital Converter (ADC) Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="comms-high.html">Application Level Communications Interfaces</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Hall Sensor Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#hall-sensor-usage">Hall Sensor Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hall-sensor-client">Hall Sensor Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hall-sensor-server-implementation">Hall Sensor Server Implementation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="qei.html">Quadrature Encoder Input</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Resource usage</a></li>
</ul>

<div id="searchbox" style="display: none;margin-bottom: 10px;">
  <h3>Search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>



    <div class="footer">
    </div>
  </body>
</html>



